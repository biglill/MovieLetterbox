<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.Button?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.PasswordField?>
<?import javafx.scene.control.ScrollPane?>
<?import javafx.scene.control.Slider?>
<?import javafx.scene.control.TextArea?>
<?import javafx.scene.control.TextField?>
<?import javafx.scene.image.ImageView?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.StackPane?>
<?import javafx.scene.layout.VBox?>
<?import javafx.scene.shape.Circle?>
<?import javafx.scene.shape.SVGPath?>
<?import javafx.scene.layout.Region?>

<StackPane xmlns="http://javafx.com/javafx/21" xmlns:fx="http://javafx.com/fxml/1"
           fx:controller="movieLetterbox.controller.ProfileController"
           stylesheets="@Style.css" styleClass="root">

    <ScrollPane fx:id="profileViewPane" fitToWidth="true" styleClass="scroll-pane-transparent">
        <content>
            <VBox spacing="40" style="-fx-padding: 40 60;">

                <!-- Top Bar: Return Button -->
                <HBox alignment="TOP_RIGHT">
                    <Button text="Return" onAction="#handleBackAction" styleClass="button-return"/>
                </HBox>

                <!-- Profile Header -->
                <HBox spacing="40" alignment="CENTER_LEFT">
                    <!-- Large Circular Profile Image -->
                    <StackPane>
                        <Circle radius="75" fill="white" stroke="black" strokeWidth="2"/>
                        <ImageView fx:id="viewProfileImage" fitHeight="150" fitWidth="150" preserveRatio="true">
                            <clip>
                                <Circle centerX="75" centerY="75" radius="75"/>
                            </clip>
                        </ImageView>
                    </StackPane>

                    <VBox spacing="15" alignment="CENTER_LEFT">
                        <HBox spacing="20" alignment="CENTER_LEFT">
                            <Label fx:id="viewUsernameLabel" text="UserName" styleClass="profile-page-username" style="-fx-font-size: 42px;"/>

                            <!-- ACTIONS CONTAINER -->
                            <HBox spacing="10" alignment="CENTER_LEFT">
                                <Button fx:id="editProfileButton" text="Edit Profile" onAction="#handleEditProfileAction" styleClass="button-edit-profile"/>
                                <!-- NEW: Follow Button (Hidden by default) -->
                                <Button fx:id="followButton" text="Follow" onAction="#handleFollowAction" styleClass="button" visible="false" managed="false"/>
                                <!-- NEW: "Follows you" Label (Hidden by default) -->
                                <Label fx:id="followsYouLabel" text="Follows you" visible="false" managed="false"/>
                            </HBox>
                        </HBox>
                        <Label fx:id="viewBioLabel" text="Bio:" styleClass="profile-page-bio" style="-fx-font-size: 16px;"/>
                        <!-- NEW: Community Button -->
                        <Button text="Community" onAction="#handleCommunityAction" styleClass="button-small"/>
                    </VBox>
                </HBox>

                <!-- Section: Favorite Films -->
                <VBox spacing="20">
                    <Label text="Favorite Films" styleClass="section-header"/>
                    <HBox fx:id="favoritesContainer" spacing="30" alignment="CENTER">
                        <!-- Favorites will be loaded here dynamically by ProfileController -->
                    </HBox>
                </VBox>
            </VBox>
        </content>
    </ScrollPane>

    <!-- EDIT PROFILE FORM -->
    <VBox fx:id="editProfilePane" visible="false" alignment="CENTER" style="-fx-background-color: rgba(255,255,255,0.95);">
        <VBox alignment="CENTER" maxWidth="500" spacing="15" style="-fx-padding: 30; -fx-background-color: white; -fx-background-radius: 10; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.1), 10, 0, 0, 2);">
            <Label text="Edit Profile Details" styleClass="title-label" style="-fx-font-size: 20px;"/>
            <Label fx:id="statusLabel" styleClass="feedback-label" />

            <VBox alignment="CENTER" spacing="10">
                <StackPane fx:id="imageCropContainer" maxWidth="100" maxHeight="100" styleClass="profile-image-view" style="-fx-cursor: hand;">
                    <ImageView fx:id="profileImageView" fitHeight="100" fitWidth="100" preserveRatio="true" pickOnBounds="true" />
                </StackPane>
                <VBox alignment="CENTER" spacing="5.0" maxWidth="200">
                    <Label text="Zoom &amp; Drag" style="-fx-font-size: 10px; -fx-text-fill: #666;"/>
                    <Slider fx:id="zoomSlider" min="1" max="3" value="1" blockIncrement="0.1" disable="true"/>
                </VBox>
                <Button text="Change Photo" onAction="#handleChangePhotoAction" styleClass="button-small"/>
            </VBox>

            <VBox spacing="5" alignment="CENTER_LEFT" maxWidth="400">
                <Label text="Username" style="-fx-font-weight: bold;"/>
                <TextField fx:id="usernameField" styleClass="text-input"/>
            </VBox>

            <VBox spacing="5" alignment="CENTER_LEFT" maxWidth="400">
                <Label text="Bio" style="-fx-font-weight: bold;"/>
                <TextArea fx:id="bioArea" prefRowCount="3" wrapText="true" styleClass="text-input"/>
            </VBox>

            <VBox spacing="5" alignment="CENTER_LEFT" maxWidth="400">
                <Label text="Password" style="-fx-font-weight: bold;"/>
                <Button text="Change Password" onAction="#handleChangePasswordAction" styleClass="button-small"/>
            </VBox>

            <HBox spacing="10" alignment="CENTER">
                <Button text="Cancel" onAction="#handleCancelEditAction" styleClass="button-secondary"/>
                <Button text="Save Changes" onAction="#handleSaveAction" styleClass="button"/>
            </HBox>
        </VBox>
    </VBox>

    <!-- CHANGE PASSWORD FORM -->
    <VBox fx:id="changePasswordPane" visible="false" alignment="CENTER" style="-fx-background-color: rgba(0,0,0,0.5);">
        <VBox alignment="CENTER" maxWidth="400" spacing="15" style="-fx-padding: 30; -fx-background-color: white; -fx-background-radius: 10; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.1), 10, 0, 0, 2);">
            <Label text="Change Password" styleClass="title-label" style="-fx-font-size: 20px;"/>
            <Label fx:id="passwordStatusLabel" styleClass="feedback-label" />
            <VBox spacing="5" alignment="CENTER_LEFT" maxWidth="350">
                <Label text="Current Password" style="-fx-font-weight: bold;"/>
                <PasswordField fx:id="currentPasswordField" styleClass="text-input"/>
            </VBox>
            <VBox spacing="5" alignment="CENTER_LEFT" maxWidth="350">
                <Label text="New Password" style="-fx-font-weight: bold;"/>
                <PasswordField fx:id="newPasswordField" styleClass="text-input"/>
            </VBox>
            <VBox spacing="5" alignment="CENTER_LEFT" maxWidth="350">
                <Label text="Confirm New Password" style="-fx-font-weight: bold;"/>
                <PasswordField fx:id="confirmNewPasswordField" styleClass="text-input"/>
            </VBox>
            <HBox spacing="10" alignment="CENTER">
                <Button text="Cancel" onAction="#handleCancelPasswordAction" styleClass="button-secondary"/>
                <Button text="Update Password" onAction="#handleUpdatePasswordAction" styleClass="button"/>
            </HBox>
        </VBox>
    </VBox>

    <!-- NEW: COMMUNITY POPUP -->
    <VBox fx:id="communityPane" visible="false" alignment="CENTER" style="-fx-background-color: rgba(0,0,0,0.5);">
        <VBox alignment="TOP_CENTER" maxWidth="500" maxHeight="600" spacing="15" style="-fx-padding: 30; -fx-background-color: white; -fx-background-radius: 10; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.1), 10, 0, 0, 2);">
            <HBox alignment="CENTER_LEFT">
                <Label text="Community" styleClass="title-label" style="-fx-font-size: 24px;"/>
                <Region HBox.hgrow="ALWAYS"/>
                <Button text="X" onAction="#handleCloseCommunityAction" style="-fx-background-color: transparent; -fx-text-fill: #999; -fx-font-weight: bold; -fx-cursor: hand;"/>
            </HBox>

            <HBox spacing="20" alignment="CENTER">
                <Button text="Followers" onAction="#handleShowFollowers" styleClass="button-secondary"/>
                <Button text="Following" onAction="#handleShowFollowing" styleClass="button-secondary"/>
            </HBox>

            <ScrollPane fitToWidth="true" styleClass="scroll-pane-transparent" VBox.vgrow="ALWAYS">
                <content>
                    <VBox fx:id="userListContainer" spacing="10" style="-fx-padding: 10;">
                        <!-- User cards go here -->
                    </VBox>
                </content>
            </ScrollPane>
        </VBox>
    </VBox>
</StackPane>